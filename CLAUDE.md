# 기본 원칙

## 프로젝트 개요

- **목적**: 📖🐰(북토끼/Booktoki) 웹 소설 사이트에서 브라우저 상에서 직접 소설을 다운로드할 수 있는 도구를 제공한다.
- **주요 기능**:
  - 여러 소설 에피소드를 일괄 다운로드
  - 텍스트 파일 또는 ZIP 아카이브로 저장
  - 브라우저 콘솔 또는 북마클릿에서 실행
  - 진행률 표시줄이 포함된 모던 UI
  - CAPTCHA 감지 및 재시도 기능
- **실행 환경**: 최신 Chromium 계열 브라우저(Chrome, Edge 등)에서 바닐라 JavaScript 실행. 외부 의존성은 JSZip만 사용.

## 기술 스택

- **바닐라 JavaScript (ES6+)**: DOM 조작, Fetch API, 동적 UI 컴포넌트 생성
- **JSZip 3.10.1**: 여러 파일의 ZIP 압축(CDN 통해 로드)
- **DOMParser**: HTML 파싱 및 콘텐츠 추출
- **Fetch API**: 비동기 페이지 가져오기 및 CORS 대응
- **CSS-in-JS**: 동적 스타일 생성 및 애니메이션(`@keyframes`)

## 개발 방침

- **MUST**
  - **사이트 부하 최소화**: 기본 5초 지연을 준수하고, 레이트 리밋(분당 20회)을 넘지 않도록 설계한다.
  - **사용자 경험 우선**: 모달 UI는 시각적 피드백과 접근성(키보드 조작)을 제공한다.
  - **에러 처리**: CAPTCHA 감지, 네트워크 오류, 파싱 실패를 사용자에게 알린다.
- **SHOULD**
  - **단계적 기능 추가**: 새 기능은 콘솔 실행으로 검증 후 북마클릿에 통합한다.
  - **코드 가독성**: 함수는 단일 책임을 가지며, 300줄 이상의 긴 함수는 분리한다.
- **NEVER**
  - **사이트 규약 위반**: 병렬 다운로드, 극단적 고속화, 불법 접근으로 이어지는 구현은 하지 않는다.
  - **사용자 데이터 전송**: 모든 처리는 브라우저 내에서만 수행하며, 외부 서버로 데이터 전송하지 않는다.

## 품질 기준

- **MUST**
  - **CAPTCHA 처리**: 감지 시 사용자에게 알리고, 수동 해결 후 재시도 흐름을 제공한다.
  - **DOM 선택의 견고성**: 여러 대체 셀렉터로 요소 획득을 시도하여 사이트 구조 변경에 대응한다.
  - **진행 상황 가시화**: 다운로드 진행 상황, 성공/실패 횟수, 남은 시간을 실시간으로 표시한다.
- **SHOULD**
  - **UI 일관성**: 모달, 버튼, 입력 필드의 스타일을 통일하고, hover 효과를 제공한다.
  - **로그 출력**: 디버깅을 위해 `console.log`로 주요 처리 플로우를 기록하며, 운영 환경에서도 유지한다.
- **NEVER**
  - **블로킹 처리**: 장시간 처리 시 반드시 비동기화하여 UI 스레드를 막지 않는다.

## JavaScript 코딩 규약

- **네이밍**: 함수는 `camelCase`, 상수는 `SCREAMING_SNAKE_CASE`, DOM 요소 변수는 `xxxElement` 사용.
- **비동기 처리**: `async/await` 사용, `Promise.then()` 체인은 지양.
- **DOM 조작**: `Object.assign()`으로 스타일 일괄 적용, `createElement()`로 요소 생성, `innerHTML`은 정적 콘텐츠에만 사용.
- **에러 처리**: `try/catch`로 예외를 잡고 `console.error`로 기록한 뒤, 사용자에게 `alert()` 또는 UI 알림.
- **주석 정책**:
  - 처리 시작/종료 시 `console.log`로 함수명과 파라미터 기록
  - 복잡한 로직은 간단한 인라인 주석
  - TODO/FIX는 GitHub Issues에서 관리하며 코드 내에 남기지 않음

## 코드 포맷 설정(Biome 호환)

- **인덴트**: 탭 문자(실질적 2 스페이스 너비로 표시)
- **최대 줄 길이**: 100자
- **세미콜론**: 필수
- **따옴표**: 더블 쿼트 우선
- **네이밍 규칙**: camelCase(함수·변수), PascalCase(미사용)

## 실행 전 체크리스트

- **브라우저 확인**: Chrome/Edge 최신판에서 테스트(Firefox/Safari 비권장).
- **사이트 접근**: 📖🐰 소설 에피소드 목록 페이지에서 실행(`https://booktoki` 시작 URL).
- **알림 허용**: 다운로드 완료 알림 수신을 위해 데스크톱 알림 활성화(선택).
- **스토리지 용량**: 1000화 이상 ZIP은 100MB 초과 가능성 있으므로 여유 공간 확인.

## 에러 처리 및 제한 사항

- **CAPTCHA 감지**: `fetchNovelContent()`가 `null`을 반환하면 사용자 확인 다이얼로그 표시 후 수동 해결 유도.
- **레이트 리밋**: 5초 간격(기본)을 유지하고 분당 20회를 초과하지 않는다. 변경 시 경고 UI 표시.
- **네트워크 오류**: `fetch()` 실패 시 해당 에피소드를 건너뛰고 실패 카운트 증가.
- **DOM 파싱 실패**: 여러 셀렉터 시도 후에도 요소를 찾지 못하면 건너뛰고 `console.error` 기록.
- **파일명 정규화**: `/\?%*:|"<>`를 `_`로 치환하여 OS 파일시스템 호환성 확보.

## 워크플로우

1. **요구사항 정의**: GitHub Issues에서 기능 요청 또는 버그 리포트 확인
2. **로컬 검증**: 브라우저 콘솔에서 `script.js` 실행, 대상 사이트에서 동작 확인
3. **북마클릿 갱신**: `bookmark.js`를 최신 `script.js` URL로 갱신하고, 압축판(`script.min.js`) 생성
4. **커밋 & PR**: 변경사항을 `README.md`에 기록하고, 테스트 결과 및 스크린샷 첨부
5. **릴리스**: `main` 브랜치에 머지 후, GitHub 릴리스 노트에 변경점 기록

## 테스트·검증 절차

### 로컬 테스트

```bash
# script.js를 브라우저 콘솔에 붙여넣어 실행
# 또는
# 북마클릿을 브라우저 북마크바에 등록하여 실행
```

### 동작 확인 포인트

- 에피소드 수 정확히 탐지(1000화 이상 시 페이지네이션 대응)
- 시작/종료 회차 범위 지정 정확성
- CAPTCHA 감지 시 적절한 사용자 알림
- 진행 상황 표시 정확성(남은 시간, 처리 속도)
- 다운로드 완료 후 파일 무결성(문자 깨짐/누락 없음)

## 파일 구성

```bash
novel-dl/
├── script.js          # 메인 스크립트(비압축, 개발용)
├── fetch.js           # HTML 획득·파싱·파일 생성 로직
├── bookmark.js        # 북마클릿용 로더(비압축판 로드)
├── README.md          # 사용 방법과 FAQ
├── LICENSE            # 라이선스 정보
├── CLAUDE.md          # 본 파일(개발 가이드)
└── novel-dl.code-workspace # VS Code 설정
```

### 각 파일 역할

- **`script.js`**: UI 흐름 제어, `fetch.js` 함수 호출해 처리 통합
- **`fetch.js`**: 네트워크 처리, DOM 파싱, 텍스트 정리, 파일 생성
- **`bookmark.js`**: CDN 통해 `script.js`를 동적으로 로드하는 북마클릿 코드

## 의존성 관리

- **외부 라이브러리**: JSZip 3.10.1(CDN: `https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js`)
- **버전 고정**: CDN URL에 버전 번호 포함, 파괴적 변경 방지
- **폴백**: JSZip 로드 실패 시 단일 파일 저장만 제공

## 문서 갱신 정책

- **기능 추가 시**: `README.md`의 Features 섹션과 본 파일의 "주요 기능" 업데이트
- **사양 변경 시**: 본 파일의 해당 섹션(에러 처리, 코딩 규약 등) 업데이트
- **버그 수정 시**: GitHub Issues 닫고, 릴리스 노트에 기록
- **파괴적 변경 시**: README에 마이그레이션 가이드 추가, 구버전과의 호환성 명시
